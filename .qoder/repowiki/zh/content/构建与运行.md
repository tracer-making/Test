# 构建与运行

<cite>
**本文档引用的文件**  
- [main.cpp](file://Tracer/src/main.cpp)
- [App.h](file://Tracer/src/core/App.h)
- [App.cpp](file://Tracer/src/core/App.cpp)
- [MainMenuState.cpp](file://Tracer/src/states/MainMenuState.cpp)
- [TemperState.cpp](file://Tracer/src/states/TemperState.cpp)
- [Button.cpp](file://Tracer/src/ui/Button.cpp)
- [Tracer.sln](file://Tracer.sln)
</cite>

## 目录
1. [简介](#简介)
2. [前置条件](#前置条件)
3. [项目目录结构](#项目目录结构)
4. [Windows平台编译说明](#windows平台编译说明)
5. [字体与资源文件配置](#字体与资源文件配置)
6. [可执行文件与DLL部署](#可执行文件与dll部署)
7. [常见运行时错误及解决方案](#常见运行时错误及解决方案)
8. [使用IDE构建项目](#使用ide构建项目)

## 简介
本项目“溯洄遗梦”是一个基于SDL2与SDL2_ttf库开发的C++游戏应用，具备复杂的UI渲染、中文文本显示和动态视觉效果。本文档旨在为开发者提供从零开始编译并运行该项目的完整指南，涵盖环境配置、编译命令、资源管理及故障排查。

**Section sources**
- [main.cpp](file://Tracer/src/main.cpp#L1-L14)
- [App.h](file://Tracer/src/core/App.h#L1-L31)

## 前置条件
在编译本项目前，请确保满足以下所有前置条件：

- **C++17兼容编译器**：支持C++17标准的编译器，推荐使用：
  - GCC 7及以上版本（MinGW-w64）
  - Microsoft Visual Studio 2017或更高版本（MSVC）
- **SDL2开发库**：必须安装SDL2开发包，包含头文件与静态/动态链接库。
- **SDL2_ttf扩展库**：用于支持TrueType字体渲染，特别是中文显示。
- **构建工具链**：
  - 若使用命令行编译，需配置好g++或cl编译器路径。
  - 若使用CMake，需安装CMake 3.10+。
  - 推荐使用Visual Studio解决方案文件（`.sln`）进行构建。

**Section sources**
- [App.cpp](file://Tracer/src/core/App.cpp#L1-L78)
- [Tracer.sln](file://Tracer.sln)

## 项目目录结构
项目的源码组织如下：

```
Tracer/
├── src/
│   ├── core/             # 核心应用逻辑
│   ├── states/           # 游戏状态实现
│   ├── ui/               # 用户界面组件
│   └── main.cpp          # 程序入口
└── assets/
    └── fonts/
        └── SIMHEI.TTF    # 中文字体文件（必需）
```

**重要提示**：`assets/fonts/`目录必须存在，并包含名为`SIMHEI.TTF`的字体文件，否则将导致中文无法渲染。

**Section sources**
- [main.cpp](file://Tracer/src/main.cpp#L1-L14)
- [MainMenuState.cpp](file://Tracer/src/states/MainMenuState.cpp#L215-L260)

## Windows平台编译说明
### 使用g++命令行编译
若使用MinGW-w64工具链，可在项目根目录执行以下命令进行编译：

```bash
g++ ^
-Iinclude ^
-Llib ^
-o Tracer.exe ^
src/main.cpp ^
src/core/App.cpp ^
src/core/Deck.cpp ^
src/states/*.cpp ^
src/ui/Button.cpp ^
-lSDL2main -lSDL2 -lSDL2_ttf
```

**说明**：
- `-Iinclude`：指向SDL2头文件目录。
- `-Llib`：指向SDL2库文件目录（`.lib`或`.a`）。
- `-lSDL2 -lSDL2_ttf`：链接SDL2主库与TTF扩展库。
- 所有`.cpp`文件需显式列出或通配符包含（如`src/states/*.cpp`）。

### 使用Visual Studio编译
打开`Tracer.sln`解决方案文件，选择目标平台（x86/x64），直接点击“生成”即可完成编译。项目已配置好包含目录与库依赖。

**Section sources**
- [App.cpp](file://Tracer/src/core/App.cpp#L1-L78)
- [Tracer.sln](file://Tracer.sln)

## 字体与资源文件配置
项目依赖`SIMHEI.TTF`（黑体）字体文件以正确渲染中文文本。该文件必须位于：

```
assets/fonts/SIMHEI.TTF
```

**验证方式**：
- 确保路径拼写完全正确，包括大小写。
- 文件应为TrueType格式（`.ttf`），不可替换为`.otf`或其他格式。
- 若字体加载失败，程序日志将输出`TTF_OpenFont Error`。

代码中通过`TTF_RenderUTF8_Blended`函数调用渲染UTF-8编码的中文字符串，如`u8"溯洄遗梦"`。

**Section sources**
- [MainMenuState.cpp](file://Tracer/src/states/MainMenuState.cpp#L215-L260)
- [TemperState.cpp](file://Tracer/src/states/TemperState.cpp#L81-L95)

## 可执行文件与DLL部署
编译生成的`Tracer.exe`必须与以下DLL文件位于同一目录下才能正常运行：

- `SDL2.dll`
- `SDL2_ttf.dll`
- `freetype.dll`（SDL2_ttf依赖）
- `zlib1.dll`（可能依赖）

**建议做法**：
1. 将上述DLL从SDL2开发包的`bin/`目录复制到`Tracer.exe`所在目录。
2. 或将DLL路径加入系统`PATH`环境变量。

否则运行时会提示“程序无法启动，因为缺少xxx.dll”。

**Section sources**
- [App.cpp](file://Tracer/src/core/App.cpp#L1-L78)

## 常见运行时错误及解决方案
### 错误1：字体加载失败
**现象**：程序启动后无中文显示，控制台输出`TTF_OpenFont Error`。

**解决方案**：
- 检查`assets/fonts/SIMHEI.TTF`是否存在。
- 确认文件名拼写正确（区分大小写）。
- 验证字体文件未损坏，可用字体查看器打开。

### 错误2：窗口无法创建
**现象**：程序立即退出，日志显示`CreateWindow Error`。

**解决方案**：
- 检查`SDL_Init(SDL_INIT_VIDEO)`返回值，确保显卡驱动正常。
- 尝试以管理员权限运行。
- 确保未与其他全屏应用冲突。

### 错误3：缺少DLL文件
**现象**：弹出对话框提示“找不到SDL2.dll”等。

**解决方案**：
- 将所需DLL复制到可执行文件同目录。
- 使用`Dependency Walker`工具检查缺失的依赖项。

**Section sources**
- [App.cpp](file://Tracer/src/core/App.cpp#L1-L78)
- [MainMenuState.cpp](file://Tracer/src/states/MainMenuState.cpp#L215-L260)

## 使用IDE构建项目
推荐使用以下IDE导入项目以简化构建流程：

### Visual Studio
- 打开`Tracer.sln`文件。
- 配置包含目录：`include/SDL2`。
- 配置库目录：`lib/`。
- 添加依赖库：`SDL2.lib`, `SDL2main.lib`, `SDL2_ttf.lib`。

### Code::Blocks / Dev-C++
- 创建新项目，添加所有`.cpp`文件。
- 在编译选项中添加：
  ```
  -Iinclude -Llib -lSDL2 -lSDL2_ttf
  ```

### CLion / VS Code
- 配置`CMakeLists.txt`（若存在）或手动设置编译命令。
- 确保IntelliSense能识别SDL2头文件路径。

**Section sources**
- [Tracer.sln](file://Tracer.sln)
- [App.h](file://Tracer/src/core/App.h#L1-L31)