# 意境刻画系统

意境刻画是"溯洄遗梦"中独特的卡牌强化系统，通过收集"意"（印记）和"境"（部类）并进行组合，为特定部类的卡牌提供额外能力。

## 系统概述

意境刻画系统允许玩家通过收集不同的"意"（印记）和"境"（部类）来定制卡牌效果。当玩家收集到意和境后，可以进行组合，使得特定部类的卡牌在战斗中自动获得对应的印记。

## 核心概念

### 意（Yi）- 印记

"意"代表卡牌可以获得的具体能力或印记，是卡牌的强化属性。常见的意包括：
- 不死印记
- 空袭
- 护主
- 双重攻击
- 水袭
- 坚硬之躯

### 境（Jing）- 部类

"境"代表卡牌的部类或类型，如：
- 介部
- 鹿部
- 犬部
- 羽部
- 鳞部

## 系统功能详解

### 1. 意境收集功能

玩家通过进入[EngraveState](../Tracer/src/states/EngraveState.h)状态来收集意和境：

- 系统随机提供三个选项（意或境）
- 玩家从中选择一个进行收集
- 收集的意和境会存储在[EngraveStore](../Tracer/src/core/EngraveStore.h)中
- 玩家可以多次进入该界面收集更多意和境

### 2. 意境组合功能

当玩家收集到多个意或多个境时，系统会进入组合模式：

- 系统检测到玩家拥有多个意或多个境
- 显示组合界面，让玩家选择要组合的意和境
- 玩家选择后，系统将意和境进行绑定
- 绑定关系存储在`categoryToMarks_`映射中

### 3. 自动应用功能

意境效果会在特定时机自动应用到卡牌上：

- 当卡牌进入战场时
- 当卡牌被创建时
- 系统检查卡牌的部类是否与已绑定的境匹配
- 如果匹配且卡牌没有该印记，则自动添加对应印记

### 4. 数据存储功能

[EngraveStore](../Tracer/src/core/EngraveStore.h)负责管理所有意境数据：

- 存储已收集的意和境
- 管理意和境的绑定关系
- 提供接口供其他系统查询和应用意境效果
- 支持添加、查询和清除意境数据

### 5. 界面交互功能

[EngraveState](../Tracer/src/states/EngraveState.h)提供完整的用户界面：

- 三选一的选择界面
- 已收集意和境的展示
- 组合选择界面
- 视觉反馈和动画效果
- 返回地图的导航功能

## EngraveStore 类详解

[EngraveStore](../Tracer/src/core/EngraveStore.h)是意境刻画系统的核心存储类。

### 主要方法

1. **数据收集方法**：
   - `selectYi()` - 选择并添加意（印记）
   - `selectJing()` - 选择并添加境（部类）
   - `addYi()` - 添加意（印记）
   - `addJing()` - 添加境（部类）

2. **组合管理方法**：
   - `combine()` - 手动组合意和境
   - `autoCombine()` - 自动组合（当恰好有一个意和一个境时）

3. **效果应用方法**：
   - `applyToCard()` - 将意境效果应用到卡牌

4. **数据访问方法**：
   - `yis()` - 获取所有已收集的意
   - `jings()` - 获取所有已收集的境
   - `bindings()` - 获取当前的绑定关系
   - `getLastCombineHint()` - 获取最后的组合提示

### 数据结构

```cpp
std::vector<std::string> yis_;  // 已收集的意列表
std::vector<std::string> jings_;  // 已收集的境列表
std::map<std::string, std::vector<std::string>> categoryToMarks_;  // 境到意的绑定映射
std::string lastCombineHint_;  // 最后的组合提示
```

## EngraveState 状态详解

[EngraveState](../Tracer/src/states/EngraveState.h)是意境刻画系统的用户界面状态。

### 界面组成

1. **选择区域**：
   - 显示三个随机选项（意或境）
   - 圆形表示意（印记），方形表示境（部类）
   - 点击选择后立即生效

2. **已收集展示区域**：
   - 显示玩家已收集的所有意和境
   - 圆形图标表示意，方形图标表示境
   - 始终可见，方便玩家了解收集进度

3. **组合选择界面**：
   - 当收集到多个意或多个境时出现
   - 允许玩家选择要组合的意和境
   - 选择后自动完成组合

4. **反馈信息区域**：
   - 显示操作结果提示
   - 显示组合成功信息
   - 提供系统提示信息

### 核心方法

1. **初始化方法**：
   - `onEnter()` - 状态进入时初始化界面
   - `buildRandomChoices()` - 生成随机选择项
   - `layoutChoices()` - 布局选择项

2. **事件处理方法**：
   - `handleEvent()` - 处理鼠标点击等事件
   - 处理选择点击
   - 处理组合界面点击

3. **更新方法**：
   - `update()` - 更新动画和状态
   - 处理状态切换

4. **渲染方法**：
   - `render()` - 渲染界面
   - 渲染选择项
   - 渲染已收集项
   - 渲染组合界面

## 使用流程

### 1. 进入意境刻画界面

玩家通过地图探索进入意境刻画状态：
1. 在地图中选择相应节点
2. 系统切换到[EngraveState](../Tracer/src/states/EngraveState.h)
3. 界面初始化，显示三个随机选项

### 2. 收集意和境

玩家收集意和境的过程：
1. 从三个选项中选择一个意或境
2. 选择后立即添加到收集列表
3. 可以重复进入界面继续收集

### 3. 组合意境

当收集到多个意或境时进行组合：
1. 系统检测到多个意或多个境
2. 显示组合选择界面
3. 玩家分别选择要组合的意和境
4. 系统完成组合并存储绑定关系

### 4. 应用意境效果

意境效果在战斗中自动应用：
1. 卡牌进入战场时
2. 系统检查卡牌部类
3. 如果部类匹配已绑定的境
4. 自动为卡牌添加对应印记

## 策略深度

### 收集策略

1. **平衡收集**：同时收集意和境以启用组合功能
2. **专精收集**：专注于收集特定类型的意或境
3. **时机选择**：根据当前卡组构成决定收集优先级

### 组合策略

1. **部类匹配**：选择与主力卡组部类匹配的境
2. **能力协同**：选择能与卡牌原有能力协同的意
3. **战术适应**：根据不同对手选择合适的意境组合

## 技术实现细节

### 自动组合机制

```cpp
void EngraveStore::autoCombine() {
    if (yis_.size() == 1 && jings_.size() == 1) {
        // 恰好只有一个意和一个境，自动组合
        combine(jings_[0], yis_[0]);
    }
    // 如果有多个意或多个境，不自动组合，让玩家选择
}
```

### 效果应用机制

```cpp
void EngraveStore::applyToCard(Card& card) const {
    auto it = categoryToMarks_.find(card.category);
    if (it == categoryToMarks_.end()) return;
    for (const auto& mk : it->second) {
        if (std::find(card.marks.begin(), card.marks.end(), mk) == card.marks.end()) {
            card.marks.push_back(mk);
        }
    }
}
```

### 界面交互机制

在[EngraveState.cpp](../Tracer/src/states/EngraveState.cpp)中处理用户交互：
- 鼠标点击选择
- 组合界面交互
- 状态切换控制

## 系统集成

意境刻画系统与游戏其他系统紧密集成：

1. **与卡牌系统集成**：
   - 为卡牌提供额外印记
   - 影响卡牌战斗能力

2. **与战斗系统集成**：
   - 在卡牌入场时应用意境效果
   - 影响战斗策略和结果

3. **与地图系统集成**：
   - 通过地图节点进入意境刻画界面
   - 作为游戏进程的一部分

4. **与存储系统集成**：
   - 使用EngraveStore存储意境数据
   - 数据在游戏会话间持久化

意境刻画系统为"溯洄遗梦"提供了深度的卡牌定制机制，玩家需要根据自己的战术需求和卡组构成来收集和组合意与境，从而打造出独特的卡牌能力，增加了游戏的策略性和重玩价值。